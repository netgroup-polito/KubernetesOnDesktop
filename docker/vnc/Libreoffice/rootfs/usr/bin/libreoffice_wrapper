#!/bin/sh

#
# This small wrapper is used to gracefully terminate Libreoffice.  It prevents
# the application to receive termination signals directly.  Instead, the wrapper
# traps signals and send CTRL+q key presses to Libreoffice.
#

FF_PID=0

# Gracefully terminate Libreoffice.  This function is called when this script
# receives a termination signal (SIGKILL, SIGINT or SIGQUIT).
kill_libreoffice() {
    # Gracefully close Libreoffice.
    echo "Terminating Libreoffice..."
    xdotool key "Escape"
    xdotool key "ctrl+q"

    # And wait for its termination.
    if [ "$FF_PID" -ne 0 ]; then
        wait $FF_PID
        exit $?
    fi
}
trap 'kill_libreoffice' TERM INT QUIT

# This function is called when this script exits.  It makes sure that Libreoffice is
# fully closed by waiting for all its processes to terminate.
exit_wrapper() {
    echo "Waiting for Libreoffice to completely terminate..."
    TIMEOUT=10
    while libreoffice_running && [ "$TIMEOUT" -gt 0 ]; do
        TIMEOUT="$(expr "$TIMEOUT" - 1)"
        sleep 1
    done

    if [ "$TIMEOUT" -gt 0 ]; then
        echo "Libreoffice terminated."
    else
        echo "WARNING: Libreoffice still not terminated."
    fi
}
trap 'exit_wrapper' EXIT

libreoffice_running() {
    ps | grep -v grep | grep -q '/usr/lib/libreoffice'
}

# Make sure to terminate any existing instance.
if libreoffice_running; then
    kill_libreoffice
fi

# Start Libreoffice in background.
/usr/bin/libreoffice "$@" &

# And wait for its termination.
FF_PID=$!
wait $FF_PID
exit $?
